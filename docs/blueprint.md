# System Blueprint

This document outlines the system design, ensuring that the `blueprint.md` is in complete alignment with `ARCHITECTURE.md` and `backend.json`.

## 1. Authentication Boundary

- **Architecture:** `AuthIdentity`, `AuthSession`
- **Backend:** The `UserProfile` entity, which merges the concepts of `AuthIdentity` and `AccessPrincipal`. Authentication is handled by Firebase Auth. User profiles are stored in Firestore.
- **Firestore Collection:** `/users/{userId}`
- **Schema (`UserProfile`):**
  - `principalId`: string (Primary Key)
  - `email`: string
  - `displayName`: string
  - `photoURL`: string
  - `authProviders`: array of strings

## 2. Authorization Boundary

- **Architecture:** `AccessPrincipal`, `AccessRole`, `AccessRoleAssignment`, `AccessPolicy`
- **Backend:** `AccessPrincipal` is represented by the `UserProfile` entity. Role-based access control (RBAC) is implemented through `TenantMember` and `WorkspaceMember` relationships, which are not explicitly defined as separate entities in `backend.json` but are managed within the application logic. Access policies are enforced at the application layer.

## 3. Tenant Governance Boundary

- **Architecture:** `TenantAggregate`, `TenantMember`, `TenantPartnership`
- **Backend:** The `Organization` entity represents the `TenantAggregate`. `TenantMember` is a logical relationship, not a separate entity. `TenantPartnership` is defined in the architecture but not yet implemented in `backend.json`.
- **Firestore Collection:** `/organizations/{orgId}`
- **Schema (`Organization`):**
    - `name`: string
    - `type`: enum (`personal`, `organization`)
    - `status`: string
    - `createdAt`: timestamp

## 4. Workspace Boundary

- **Architecture:** `WorkspaceAggregate`, `WorkspaceMember`
- **Backend:** The `Workspace` entity represents the `WorkspaceAggregate`. `WorkspaceMember` is a logical relationship.
- **Firestore Collection:** `/workspaces/{workspaceId}`
- **Schema (`Workspace`):**
    - `tenantId`: string
    - `name`: string
    - `status`: string
    - `visibility`: enum (`public`, `private`)

## 5. Work Domain Aggregates

This boundary contains the core business logic aggregates, all of which are stored as sub-collections within a workspace.

- **Architecture:** `TaskAggregate`, `QaAggregate`, `AcceptanceAggregate`, `FinanceAggregate`, `IssueAggregate`
- **Backend Entities:** `Task`, `QA`, `Acceptance`, `Finance`, `Issue`

- **Firestore Sub-collections:**
  - `/workspaces/{workspaceId}/tasks/{taskId}` (Schema: `Task`)
  - `/workspaces/{workspaceId}/qas/{qaId}` (Schema: `QA`)
  - `/workspaces/{workspaceId}/acceptances/{acceptanceId}` (Schema: `Acceptance`)
  - `/workspaces/{workspaceId}/finances/{financeId}` (Schema: `Finance`)
  - `/workspaces/{workspaceId}/issues/{issueId}` (Schema: `Issue`)

## 6. Resource Boundary

- **Architecture:** `FileAggregate`
- **Backend:** The `File` entity represents a passive resource.
- **Firestore Sub-collection:** `/workspaces/{workspaceId}/files/{fileId}`
- **Schema (`File`):**
    - `workspaceId`: string
    - `name`: string
    - `type`: string
    - `url`: string (uri)

## 7. Diary Aggregate

- **Architecture:** `DiaryAggregate`
- **Backend:** The `Diary` entity represents a content/social entry.
- **Firestore Sub-collection:** `/workspaces/{workspaceId}/diaries/{diaryId}`
- **Schema (`Diary`):**
    - `workspaceId`: string
    - `authorPrincipalId`: string
    - `content`: string
    - `visibility`: enum (`public`, `workspace`, `private`)
    - `status`: enum (`active`, `archived`)
    - `createdAt`: timestamp

## 8. External Service Boundary (Conceptual)

- **Architecture:** `DocumentParserService`, `TaskDraft`
- **Backend:** This is a conceptual boundary. The `DocumentParserService` is envisioned as a microservice or cloud function that processes files to create `Task` drafts, which are then used to create `Task` aggregates. This is not directly defined in `backend.json`.

## 9. Command Boundary (Conceptual)

- **Architecture:** `DomainCommand`, `CommandHandler`
- **Backend:** This is a conceptual boundary representing the application's command layer (e.g., API endpoints, cloud functions). These are the sole entry points for mutating the state of aggregates, as enforced by application logic and Firestore security rules.

## 10. Event Boundary (Conceptual)

- **Architecture:** `DomainEvent`, `EventStore`, `ProjectionSubscriber`
- **Backend:** This is a conceptual boundary. Domain events are generated by aggregates upon state changes. An `EventStore` (e.g., a dedicated Firestore collection) could be used to persist these events, and `ProjectionSubscriber`s would then update read models or trigger other side effects.

## 11. Audit Boundary

- **Architecture:** `AuditLog`, `AuditSubscriber`
- **Backend:** The `AuditLog` entity provides a system-level audit trail. An `AuditSubscriber` (e.g., a cloud function triggered by domain events) would be responsible for creating these log entries.
- **Firestore Sub-collection:** `/organizations/{orgId}/auditLogs/{logId}`
- **Schema (`AuditLog`):**
    - `eventId`: string
    - `aggregateType`: string
    - `aggregateId`: string
    - `principalId`: string
    - `action`: string
    - `occurredAt`: timestamp
